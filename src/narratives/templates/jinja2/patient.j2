{#
  Jinja2 template for generating a narrative for the Patient resource
  following the International Patient Summary (IPS) specification.
  Expects a FHIR Bundle as input.
#}
{% for entry in resource.entry %}
  {% if entry.resource.resourceType == 'Patient' %}
    {% set patient = entry.resource %}
    <div>
      <h2>Patient Summary</h2>
      <p>Gender: {{ patient.gender }}</p>
      <ul>
        <li><strong>Name(s):</strong>
          <ul>
            {% for name in patient.name %}
              <li>{{ name.text or (name.given | join(' ')) ~ ' ' ~ name.family }}</li>
            {% endfor %}
          </ul>
        </li>
        <li><strong>Gender:</strong> {{ patient.gender|capitalize if patient.gender }}</li>
        <li><strong>Date of Birth:</strong> {{ patient.birthDate if patient.birthDate }}</li>
        <li><strong>Identifier(s):</strong>
          <ul>
            {% for id in patient.identifier %}
              <li>{{ id.system }}: {{ id.value }}</li>
            {% endfor %}
          </ul>
        </li>
        <li><strong>Telecom:</strong>
          <ul>
            {% for telecom in patient.telecom %}
              <li>{{ telecom.system|capitalize }}: {{ telecom.value }}{% if telecom.use %} ({{ telecom.use }}){% endif %}</li>
            {% endfor %}
          </ul>
        </li>
        <li><strong>Address(es):</strong>
          <ul>
            {% for address in patient.address %}
              <li>{{ address.text or (address.line | join(', ')) ~ ', ' ~ address.city ~ ', ' ~ address.country }}</li>
            {% endfor %}
          </ul>
        </li>
        <li><strong>Marital Status:</strong> {{ patient.maritalStatus.text if patient.maritalStatus }}</li>
        <li><strong>Deceased:</strong>
          {% if patient.deceasedBoolean is not none %}
            {% if patient.deceasedBoolean %}Yes{% else %}No{% endif %}
          {% endif %}
        </li>
        <li><strong>Language(s):</strong>
          <ul>
            {% for comm in patient.communication %}
              <li>{{ comm.language.text or comm.language.coding[0].display }}</li>
            {% endfor %}
          </ul>
        </li>
        <li><strong>Contact(s):</strong>
          <ul>
            {% for contact in patient.contact %}
              <li>{{ contact.name.text or (contact.name.given | join(' ')) ~ ' ' ~ contact.name.family }}</li>
            {% endfor %}
          </ul>
        </li>
        <li><strong>Managing Organization:</strong> {{ patient.managingOrganization.display if patient.managingOrganization }}</li>
        <li><strong>General Practitioner(s):</strong>
          <ul>
            {% for gp in patient.generalPractitioner %}
              <li>{{ gp.display }}</li>
            {% endfor %}
          </ul>
        </li>
        <li><strong>Birthplace:</strong> {{ patient.birthPlace.text if patient.birthPlace }}</li>
        <li><strong>Photo:</strong> {% if patient.photo and patient.photo[0].url %}<img src="{{ patient.photo[0].url }}" alt="Patient Photo" style="max-width:100px;max-height:100px;"/>{% else %}N/A{% endif %}</li>
      </ul>
    </div>
  {% endif %}
{% endfor %}
