{% from "utility-fragments.j2" import codeableConcept, renderValue, renderValueUnit, firstFromCodeableConceptList, concatReferenceRange, concat, renderTime %}

{# Diagnostic Results: Observations #}
{% if resource.entry | selectattr('resource.resourceType', 'equalto', 'Observation') | list %}
  <h5>Diagnostic Results: Observations</h5>
  <table class="hapiPropertyTable">
    <thead>
      <tr>
        <th>Code</th>
        <th>Result</th>
        <th>Unit</th>
        <th>Interpretation</th>
        <th>Reference Range</th>
        <th>Comments</th>
        <th>Date</th>
      </tr>
    </thead>
    <tbody>
      {% for entry in resource.entry %}
        {% set obs = entry.resource %}
        {% if obs.resourceType == 'Observation' %}
          {% if obs.extension is defined and obs.extension %}
            {% set extension = obs.extension | selectattr('url', 'equalto', 'http://hl7.org/fhir/StructureDefinition/narrativeLink') | map(attribute='value.value') | list | first %}
          {% else %}
            {% set extension = None %}
          {% endif %}
          <tr id="{{ extension.split('#')[1] if extension }}">
            <td>{{ codeableConcept(obs.code) }}</td>
            <td>{{ renderValue(obs.value) if obs.value is defined else '' }}</td>
            <td>{{ renderValueUnit(obs.value) if obs.value is defined else '' }}</td>
            <td>{{ firstFromCodeableConceptList(obs.interpretation) }}</td>
            <td>{{ concatReferenceRange(obs.referenceRange) }}</td>
            <td>{{ concat(obs.note, 'text') }}</td>
            <td>{{ renderTime(obs.effective) }}</td>
          </tr>
        {% endif %}
      {% endfor %}
    </tbody>
  </table>
{% endif %}
